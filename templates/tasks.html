{% extends 'base.html' %}
{% block title %}Tasks{% endblock %}
{% block content %}

<!-- Agent Statistics Dashboard -->
{% if is_agent %}
<div class="row mb-4">
  <div class="col-12">
    <div class="card border-info">
      <div class="card-header bg-info text-white">
        <h4 class="card-title mb-0">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-bar-chart-fill me-2" viewBox="0 0 16 16">
            <path d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2z"/>
          </svg>
          Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ - {{ current_user.name }}
        </h4>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Total Completed Tasks -->
          <div class="col-md-3 mb-3">
            <div class="card border-success">
              <div class="card-body text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="text-success mb-2" viewBox="0 0 16 16">
                  <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                </svg>
                <h3 class="text-success mb-1">{{ agent_stats.total_completed }}</h3>
                <p class="mb-0 text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</p>
                <small class="text-muted">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª</small>
              </div>
            </div>
          </div>
          
          <!-- Total Cars Wrapped -->
          <div class="col-md-3 mb-3">
            <div class="card border-primary">
              <div class="card-body text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="text-primary mb-2" viewBox="0 0 16 16">
                  <path d="M4 11a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm8 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2zM3 5.5A1.5 1.5 0 0 1 4.5 4h7A1.5 1.5 0 0 1 13 5.5v5a1.5 1.5 0 0 1-1.5 1.5h-7A1.5 1.5 0 0 1 3 10.5v-5zM4.5 5a.5.5 0 0 0-.5.5v5a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-5a.5.5 0 0 0-.5-.5h-7z"/>
                </svg>
                <h3 class="text-primary mb-1">{{ agent_stats.total_cars }}</h3>
                <p class="mb-0 text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØºÙ„ÙØ©</p>
                <small class="text-muted">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª</small>
              </div>
            </div>
          </div>
          
          <!-- Completed This Month -->
          <div class="col-md-3 mb-3">
            <div class="card border-info">
              <div class="card-body text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="text-info mb-2" viewBox="0 0 16 16">
                  <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                </svg>
                <h3 class="text-info mb-1">{{ agent_stats.completed_this_month }}</h3>
                <p class="mb-0 text-muted">Ù…Ù‡Ø§Ù… Ù…Ù†Ø¬Ø²Ø© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>
                <small class="text-muted">{{ current_month }}/{{ current_year }}</small>
              </div>
            </div>
          </div>
          
          <!-- Open Tasks -->
          <div class="col-md-3 mb-3">
            <div class="card border-warning">
              <div class="card-body text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="text-warning mb-2" viewBox="0 0 16 16">
                  <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
                </svg>
                <h3 class="text-warning mb-1">{{ agent_stats.open_tasks }}</h3>
                <p class="mb-0 text-muted">Ù…Ù‡Ø§Ù… Ù…ÙØªÙˆØ­Ø©</p>
                <small class="text-muted">Ù„Ù… ØªÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯</small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Monthly Target Progress -->
        {% if agent_stats.target > 0 %}
        <div class="card border-primary mt-3">
          <div class="card-body">
            <h5 class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M8 13A5 5 0 1 1 8 3a5 5 0 0 1 0 10zm0 1A6 6 0 1 0 8 2a6 6 0 0 0 0 12z"/>
                <path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/>
                <path d="M9.5 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
              </svg>
              Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ - {{ current_month }}/{{ current_year }}
            </h5>
            <div class="row align-items-center">
              <div class="col-md-8">
                <div class="d-flex justify-content-between mb-2">
                  <span>Ø§Ù„Ù…ÙÙ†Ø¬Ø²: <strong class="text-primary">{{ agent_stats.achieved_cars }} Ø³ÙŠØ§Ø±Ø© Ù…ØºÙ„ÙØ©</strong></span>
                  <span>Ø§Ù„Ù‡Ø¯Ù: <strong>{{ agent_stats.target }} Ø³ÙŠØ§Ø±Ø© Ù…ØºÙ„ÙØ©</strong></span>
                </div>
                <div class="progress" style="height: 30px;">
                  <div class="progress-bar {% if agent_stats.percentage >= 100 %}bg-success{% elif agent_stats.percentage >= 75 %}bg-warning{% else %}bg-danger{% endif %}" 
                       role="progressbar" 
                       style="width: {{ [agent_stats.percentage, 100]|min }}%; font-size: 1.1rem; font-weight: bold;"
                       aria-valuenow="{{ agent_stats.percentage }}" 
                       aria-valuemin="0" 
                       aria-valuemax="100">
                    {{ "%.1f"|format(agent_stats.percentage) }}%
                  </div>
                </div>
                <small class="text-muted mt-1 d-block">Ù…ØªØ¨Ù‚ÙŠ: {{ [agent_stats.target - agent_stats.achieved_cars, 0]|max }} Ø³ÙŠØ§Ø±Ø©</small>
              </div>
              <div class="col-md-4 text-center">
                {% if agent_stats.percentage >= 100 %}
                  <div class="alert alert-success mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                    </svg>
                    <h5 class="mt-2 mb-0">Ù…Ù…ØªØ§Ø²! ğŸ‰</h5>
                    <small>ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù</small>
                  </div>
                {% elif agent_stats.percentage >= 75 %}
                  <div class="alert alert-warning mb-0">
                    <h5>Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯ ğŸ‘</h5>
                    <small>Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‡Ø¯Ù!</small>
                  </div>
                {% else %}
                  <div class="alert alert-info mb-0">
                    <h5>Ø§Ø³ØªÙ…Ø± ğŸ’ª</h5>
                    <small>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙˆØµÙˆÙ„!</small>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Monthly Progress Dashboard -->
{% if not is_agent %}
<div class="row mb-4">
  <div class="col-12">
    <div class="card border-primary">
      <div class="card-header bg-primary text-white">
        <h4 class="card-title mb-0">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-calendar-check me-2" viewBox="0 0 16 16">
            <path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
            <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
          </svg>
          Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø´Ù‡Ø±ÙŠØ© - {{ current_month }}/{{ current_year }}
        </h4>
      </div>
      <div class="card-body">
        <div class="row">
          {% for agent in agents %}
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card {% if monthly_stats[agent.id].percentage >= 100 %}border-success{% elif monthly_stats[agent.id].percentage >= 75 %}border-warning{% else %}border-danger{% endif %}">
              <div class="card-body">
                <h6 class="card-subtitle mb-2">{{ agent.name }}</h6>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-muted">Ø§Ù„Ù‡Ø¯Ù:</span>
                  <strong>{{ monthly_stats[agent.id].target }} Ø³ÙŠØ§Ø±Ø© Ù…ØºÙ„ÙØ©</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-muted">Ø§Ù„Ù…ÙÙ†Ø¬Ø²:</span>
                  <strong class="text-primary">{{ monthly_stats[agent.id].achieved }} Ø³ÙŠØ§Ø±Ø© Ù…ØºÙ„ÙØ©</strong>
                </div>
                <div class="progress mb-2" style="height: 25px;">
                  <div class="progress-bar {% if monthly_stats[agent.id].percentage >= 100 %}bg-success{% elif monthly_stats[agent.id].percentage >= 75 %}bg-warning{% else %}bg-danger{% endif %}" 
                       role="progressbar" 
                       style="width: {{ [monthly_stats[agent.id].percentage, 100]|min }}%"
                       aria-valuenow="{{ monthly_stats[agent.id].percentage }}" 
                       aria-valuemin="0" 
                       aria-valuemax="100">
                    {{ "%.1f"|format(monthly_stats[agent.id].percentage) }}%
                  </div>
                </div>
                <small class="text-muted">Ù…ØªØ¨Ù‚ÙŠ: {{ [monthly_stats[agent.id].target - monthly_stats[agent.id].achieved, 0]|max }} Ø³ÙŠØ§Ø±Ø©</small>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="text-end mt-3">
          <a href="{{ url_for('monthly_targets') }}" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
              <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
            </svg>
            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row">
  {% if not is_agent %}
  <!-- Quick Add Task Card -->
  <div class="col-md-6 col-lg-4 mb-4">
    <div class="card border-success">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-lightning-charge-fill me-2" viewBox="0 0 16 16">
            <path d="M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09z"/>
          </svg>
          Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©
        </h5>
      </div>
      <div class="card-body">
        <form method="post" action="/tasks/quick-add">
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù…ÙˆØ¸Ù *</label>
            <select class="form-select form-select-lg" name="agent_id" required>
              <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù --</option>
              {% for a in agents %}
              <option value="{{ a.id }}">{{ a.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØºÙ„ÙØ© *</label>
            <input type="number" class="form-control form-control-lg text-center" name="car_count" min="1" value="1" required style="font-size: 1.5rem; font-weight: bold;">
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="text" class="form-control" name="title" placeholder="Ù…Ø«Ø§Ù„: ØªØºÙ„ÙŠÙ Ø§Ù„ÙŠÙˆÙ…">
          </div>
          <button class="btn btn-success btn-lg w-100" type="submit">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¢Ù†
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Create New Task Card -->
  <div class="col-md-6 col-lg-4 mb-4">
    <div class="card">
      <div class="card-header bg-warning text-dark">
        <h5 class="card-title mb-0">Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
      </div>
      <div class="card-body">
        <form method="post">
          <div class="mb-2">
            <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *</label>
            <input class="form-control" name="title" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Ø§Ù„Ù…ÙˆØ¸Ù *</label>
            <select class="form-select" name="agent_id" required>
              <option value="">-- Ø§Ø®ØªØ± --</option>
              {% for a in agents %}
              <option value="{{ a.id }}">{{ a.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØºÙ„ÙØ©</label>
            <input type="number" class="form-control" name="car_count" min="0" value="0">
          </div>
          <div class="mb-2">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
            <input class="form-control" type="date" name="due_date">
          </div>
          <div class="mb-2">
            <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
            <textarea class="form-control" name="description" rows="2"></textarea>
          </div>
          <button class="btn btn-warning w-100" type="submit">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Recent Tasks List -->
  <div class="col-md-{{ '12' if is_agent else '12' }} col-lg-{{ '12' if is_agent else '4' }} mb-4">
    <div class="card">
      <div class="card-header bg-{% if is_agent %}info{% else %}warning{% endif %} text-{% if is_agent %}white{% else %}dark{% endif %}">
        <h5 class="card-title mb-0">
          {% if is_agent %}
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
            <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
          </svg>
          Ù…Ù‡Ø§Ù…ÙŠ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù…)
          {% else %}
          Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø®ÙŠØ±Ø©
          {% endif %}
        </h5>
      </div>
      <div class="card-body" style="max-height: 600px; overflow-y: auto;">
        {% if tasks %}
        <ul class="list-group">
        {% for t in tasks %}
          <li class="list-group-item {% if t.completed %}list-group-item-success{% elif t.due_date and t.due_date < today %}list-group-item-danger{% endif %}">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                  <h6 class="mb-0"><strong>{{ t.title }}</strong></h6>
                  {% if t.completed %}
                    <span class="badge bg-success ms-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                      </svg>
                      Ù…ÙƒØªÙ…Ù„Ø©
                    </span>
                  {% else %}
                    <span class="badge bg-warning text-dark ms-2">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span>
                  {% endif %}
                  {% if t.car_count > 0 %}
                    <span class="badge bg-info ms-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4 11a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm8 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2zM3 5.5A1.5 1.5 0 0 1 4.5 4h7A1.5 1.5 0 0 1 13 5.5v5a1.5 1.5 0 0 1-1.5 1.5h-7A1.5 1.5 0 0 1 3 10.5v-5zM4.5 5a.5.5 0 0 0-.5.5v5a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-5a.5.5 0 0 0-.5-.5h-7z"/>
                      </svg>
                      {{ t.car_count }} Ø³ÙŠØ§Ø±Ø©
                    </span>
                  {% endif %}
                </div>
                
                {% if t.description %}
                <div class="alert alert-light mb-2 py-2">
                  <small><strong>Ø§Ù„ÙˆØµÙ:</strong> {{ t.description }}</small>
                </div>
                {% endif %}
                
                <div class="row">
                  {% if not is_agent %}
                  <div class="col-md-6">
                    <small class="d-block">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                        <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                      </svg>
                      <strong>Ø§Ù„Ù…ÙˆØ¸Ù:</strong> {{ t.agent.name if t.agent else 'N/A' }}
                    </small>
                  </div>
                  {% endif %}
                  <div class="col-md-6">
                    <small class="d-block">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                        <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                      </svg>
                      <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙƒÙ„ÙŠÙ:</strong> {{ t.assigned_at.strftime('%Y-%m-%d') if t.assigned_at else 'N/A' }}
                    </small>
                  </div>
                  {% if t.due_date %}
                  <div class="col-md-6">
                    <small class="d-block {% if not t.completed and t.due_date < today %}text-danger fw-bold{% endif %}">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                        <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                      </svg>
                      <strong>Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong> {{ t.due_date }}
                      {% if not t.completed and t.due_date < today %}
                        <span class="badge bg-danger ms-1">Ù…ØªØ£Ø®Ø±!</span>
                      {% endif %}
                    </small>
                  </div>
                  {% endif %}
                  {% if t.completed_at %}
                  <div class="col-md-6">
                    <small class="text-success d-block">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                      </svg>
                      <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²:</strong> {{ t.completed_at.strftime('%Y-%m-%d %H:%M') }}
                    </small>
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="btn-group-vertical ms-2">
                {% if is_agent %}
                  {# Agent: Can only mark incomplete tasks as complete, cannot reopen #}
                  {% if not t.completed %}
                    <form method="post" action="/tasks/{{ t.id }}/toggle">
                      <button type="submit" class="btn btn-sm btn-success" title="Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                {% endif %}
                
                {% if not is_agent %}
                  {# Admin: Can toggle, edit, and delete tasks #}
                  <form method="post" action="/tasks/{{ t.id }}/toggle">
                    {% if t.completed %}
                      <button type="submit" class="btn btn-sm btn-warning mb-1" title="Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ù…Ù‡Ù…Ø©">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                          <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                      </button>
                    {% else %}
                      <button type="submit" class="btn btn-sm btn-success mb-1" title="Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                      </button>
                    {% endif %}
                  </form>
                  
                  <a href="/tasks/{{ t.id }}/edit" class="btn btn-sm btn-primary mb-1" title="ØªØ¹Ø¯ÙŠÙ„">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                    </svg>
                  </a>
                  
                  <form method="post" action="/tasks/{{ t.id }}/delete" onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ');">
                    <button type="submit" class="btn btn-sm btn-danger" title="Ø­Ø°Ù">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                      </svg>
                    </button>
                  </form>
                {% endif %}
              </div>
            </div>
          </li>
        {% endfor %}
        </ul>
        {% else %}
        <div class="alert alert-info text-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="mb-3" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
          </svg>
          <h5>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</h5>
          <p class="mb-0">{% if is_agent %}Ù„Ù… ÙŠØªÙ… ØªÙƒÙ„ÙŠÙÙƒ Ø¨Ø£ÙŠ Ù…Ù‡Ø§Ù… Ø¨Ø¹Ø¯{% else %}Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù‡Ø§Ù… Ø¨Ø¹Ø¯{% endif %}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
